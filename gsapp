#!/bin/sh
set -eu
GSAPP_PATH="${GSAPP_PATH:-$HOME/.local/share/applications}"

usage() {
  cat <<__USAGE__ >&2
usage: ${0##*/} <operation> [...]
operations:
  ${0##*/} add <name> <command>   # add a new application
  ${0##*/} delete <name(s)>       # delete the specified applications
  ${0##*/} list                   # list applications
  ${0##*/} help                   # show this help message
__USAGE__
}

operation_add() {
  if [ $# -lt 2 ]; then
    echo "usage: ${0##*/} add <name> <command>" >&2
    exit 2
  fi
  if [ ! -d "$GSAPP_PATH" ]; then
    echo "${0##*/} add: \"$GSAPP_PATH\" doesn't exist" >&2
    exit 2
  fi
  (
    name="$1"
    execute="$2"
    application="$GSAPP_PATH/$name.desktop"
    if [ -f "$application" ]; then
      echo "${0##*/} add: \"$application\" has already exist" >&2
      exit 1
    fi
    cat <<__DESKTOP_FILE__ > "$application"
[Desktop Entry]
Name=$name
Exec=$execute
Type=Application
__DESKTOP_FILE__
  )
}

operation_delete() {
  if [ $# -lt 1 ]; then
    echo "usage: ${0##*/} delete <name>" >&2
    exit 2
  fi
  if [ ! -d "$GSAPP_PATH" ]; then
    echo "${0##*/} delete: \"$GSAPP_PATH\" doesn't exist" >&2
    exit 2
  fi
  (
    for name in "$@"; do
      application="$GSAPP_PATH/$name.desktop"
      if [ ! -f "$application" ]; then
        echo "${0##*/} delete: \"$application\" doesn't exist" >&2
        exit 1
      fi
      rm -- "$application"
    done
  )
}

operation_list() {
  if [ ! -d "$GSAPP_PATH" ]; then
    exit 0
  fi
  ls -- "$GSAPP_PATH" \
  | grep '.desktop$' \
  | sed 's/.desktop$//'
}

operation_help() {
  usage
}

if [ $# -lt 1 ]; then
  usage
  exit 2
fi
operation="$1"
shift
case "$operation" in
  add|delete|list|help)
    "operation_$operation" "$@"
    exit 0
    ;;
  *)
    echo "${0##*/}: invalid operation '$operation'" >&2
    exit 2
    ;;
esac
